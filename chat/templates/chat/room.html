<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
<head>
    {% load static %}
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="{% static 'my_style.css' %}">
</head>
<body>
    <div style="text-align: center">
            <h1>
                Chat Room
            </h1>
    </div>
    <div class="row">

      <div class="column">
          <p> Please enter the key words to send the video clips.</p>
          <input id="chat-message-input" type="text" size="100"/><br/>
            <input id="chat-message-submit" type="button" class="btn btn-outline-primary" value="Send"/>
            <input id="end-message-submit" type="button" class="btn btn-outline-primary" value="Exit"/>
      </div>
    </div>
    <center>
        <div id="preview" class="row">

    </div>
    </center>
    <table id="videos" class="table table-bordered">
    </table>

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    var roomName = {{ room_name_json }};
    var name = {{ user }};
    var API_KEY = "{{ env }}";

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        var video = data['videos'];
        var name = data["name"]
        if (data['exit'] == 1){
            alert(message)
        }else {
            var tr = document.createElement("tr");
            var th_name = document.createElement("th");
            th_name.innerText = name;
            var th_frame = document.createElement("th");
            var node = document.createElement("IFRAME");
            node.width = 100;
            node.height = 80;
            node.src = "https://www.youtube.com/embed/"+video;
            node.allow = "accelerometer; autoplay;encrypted-media;";
            node.value = name;
            th_frame.appendChild(node)
            th_frame.classList.add("table_col");
            tr.append(th_name);
            tr.append(th_frame);
            node.classList.add(message);
            document.getElementById("videos").appendChild(tr);

        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        messageInputDom.value = '';

        $.ajax({
            type: "GET",
            {#url: "/videos/?key="+message,#}
            url: "https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=25&q="+message+"&key="+API_KEY
        }).done((res)=>{
            items = res.items;
            message =message.replace(/\s+/g, '+');
            len = items.length > 6? 6:items.length;
            for(i=0; i<len; i++){
                video_id = items[i].id.videoId;
                var div = document.createElement("div");
                var node = document.createElement("IFRAME");
                node.width = 150;
                node.height = 100;
                node.src = "https://www.youtube.com/embed/"+video_id;
                node.allow = "accelerometer; autoplay;encrypted-media;";
                node.classList.add(video_id);
                var button = document.createElement("input");
                button.type = "button";
                button.value = "send";
                button.classList.add(video_id, "btn", "btn-outline-primary");
                button.addEventListener("click", (e)=>{
                    chatSocket.send(JSON.stringify({ 'message': message, 'videos': $(e.target).attr("class"), 'name': name }));
                    document.getElementById("preview").innerText = "";

                })
                div.classList.add("column");
                div.appendChild(node);
                div.appendChild(button);
                document.getElementById("preview").appendChild(div);
            }

        }).fail(() => {
            alert("keyword provided is wrong");
        })
    };

    document.querySelector('#end-message-submit').onclick = function(e) {
        chatSocket.send(JSON.stringify({
            'message': "The experiment is done, please go to http://questionnaire.com/ " +
            "to finish the questionnaire.",
            "exit": 1,
            'name': name
        }));
    };
</script>

</html>